AWSTemplateFormatVersion: 2010-09-09
Description: BTS Infrastructure
Resources:
 # VPC
 BTSVPC:
   Type: AWS::EC2::VPC
   Properties:
     CidrBlock: 10.0.0.0/16
     EnableDnsSupport: 'true'
     EnableDnsHostnames: 'true'
     Tags:
       - Key: Name
         Value: BTS-vpc


# Web Subnet         
 BTSwebSubnet:
   Type: AWS::EC2::Subnet
   Properties:
     VpcId: !Ref BTSVPC
     CidrBlock: 10.0.0.0/24
     AvailabilityZone: "ca-central-1a"
     MapPublicIpOnLaunch: "true"
     Tags:
     - Key: Name
       Value: BTS-web-subnet


# App Subnet         
 BTSappSubnet:
   Type: AWS::EC2::Subnet
   Properties:
     VpcId: !Ref BTSVPC
     CidrBlock: 10.0.1.0/24
     AvailabilityZone: "ca-central-1a"
     MapPublicIpOnLaunch: "true"
     Tags:
     - Key: Name
       Value: BTS-app-subnet


  # DB Subnet         
 BTSdbSubnet:
   Type: AWS::EC2::Subnet
   Properties:
     VpcId: !Ref BTSVPC
     CidrBlock: 10.0.2.0/24
     AvailabilityZone: "ca-central-1a"
     MapPublicIpOnLaunch: "false"
     Tags:
     - Key: Name
       Value: BTS-db-subnet


 # Internet Gateway
 BTSInternetGateway:
   Type: AWS::EC2::InternetGateway
   Properties:
     Tags:
     - Key: Name
       Value: BTS-igw


 # Attach Internet Gateway     
 BTSAttachGateway:
   Type: AWS::EC2::VPCGatewayAttachment
   Properties:
     VpcId:
       Ref: BTSVPC
     InternetGatewayId:
       Ref: BTSInternetGateway


 # Public Route Table
 BTSpubRouteTable:
   Type: AWS::EC2::RouteTable
   Properties:
     VpcId: 
       Ref: BTSVPC
     Tags:
     - Key: Name
       Value: BTS-pub-rt


# Internet Route
 myRoute:
   Type: AWS::EC2::Route
   DependsOn: BTSAttachGateway
   Properties:
      RouteTableId:
        Ref: BTSpubRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: BTSInternetGateway


 # RT - Subnet Association
 BTSwebSubnetRouteTableAssociation:
   Type: AWS::EC2::SubnetRouteTableAssociation
   Properties:
     SubnetId:
       Ref: BTSwebSubnet
     RouteTableId:
       Ref: BTSpubRouteTable


# RT - Subnet Association
 BTSappSubnetRouteTableAssociation:
   Type: AWS::EC2::SubnetRouteTableAssociation
   Properties:
     SubnetId:
       Ref: BTSappSubnet
     RouteTableId:
       Ref: BTSpubRouteTable


# Private Route Table
 BTSpvtRouteTable:
   Type: AWS::EC2::RouteTable
   Properties:
     VpcId: 
       Ref: BTSVPC
     Tags:
     - Key: Name
       Value: BTS-pvt-rt


 # RT - Subnet Association
 BTSdbSubnetRouteTableAssociation:
   Type: AWS::EC2::SubnetRouteTableAssociation
   Properties:
     SubnetId:
       Ref: BTSdbSubnet
     RouteTableId:
       Ref: BTSpvtRouteTable


 # RT - Subnet Association
 BTSwebNetworkAcl:
   Type: AWS::EC2::NetworkAcl
   Properties:
     VpcId:
       Ref: BTSVPC
     Tags:
       - Key: Name
         Value: BTS-web-nacl


 # Web NACL Rules
 BTSwebnaclInboundRule:
   Type: AWS::EC2::NetworkAclEntry
   Properties:
      NetworkAclId:
        Ref: BTSwebNetworkAcl
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 0
        To: 65535
 BTSwebnaclOutboundRule:
   Type: AWS::EC2::NetworkAclEntry
   Properties:
      NetworkAclId:
        Ref: BTSwebNetworkAcl
      RuleNumber: 100
      Protocol: -1
      Egress: true
      RuleAction: allow
      CidrBlock: 0.0.0.0/0


# Web NACL Association      
 BTSwebSubnetNetworkAclAssociation:
   Type: AWS::EC2::SubnetNetworkAclAssociation
   Properties:
     SubnetId:
       Ref: BTSwebSubnet
     NetworkAclId:
       Ref: BTSwebNetworkAcl


# App NACL
 BTSappNetworkAcl:
   Type: AWS::EC2::NetworkAcl
   Properties:
     VpcId:
       Ref: BTSVPC
     Tags:
       - Key: Name
         Value: BTS-app-nacl


 # App NACL Rules
 BTSappnaclInboundRule:
   Type: AWS::EC2::NetworkAclEntry
   Properties:
     NetworkAclId:
       Ref: BTSappNetworkAcl
     RuleNumber: 100
     Protocol: 6
     RuleAction: allow
     CidrBlock: 0.0.0.0/0
     PortRange:
       From: 0
       To: 65535

      
 BTSappnaclOutboundRule:
   Type: AWS::EC2::NetworkAclEntry
   Properties:
     NetworkAclId:
       Ref: BTSappNetworkAcl
     RuleNumber: 100
     Protocol: -1
     Egress: true
     RuleAction: allow
     CidrBlock: 0.0.0.0/0

  # App NACL Association      
  ecommappSubnetNetworkAclAssociation:
   Type: AWS::EC2::SubnetNetworkAclAssociation
   Properties:
     SubnetId:
       Ref: ecommappSubnet
     NetworkAclId:
       Ref: ecommappNetworkAcl
  # DB NACL
  ecommdbNetworkAcl:
   Type: AWS::EC2::NetworkAcl
   Properties:
     VpcId:
       Ref: ecommVPC
     Tags:
       - Key: Name
         Value: ecomm-db-nacl

  # DB NACL Rules
  ecommdbnaclInboundRule:
   Type: AWS::EC2::NetworkAclEntry
   Properties:
     NetworkAclId:
       Ref: ecommdbNetworkAcl
     RuleNumber: 100
     Protocol: 6
     RuleAction: allow
     CidrBlock: 0.0.0.0/0
     PortRange:
       From: 0
       To: 65535
      
    




     
